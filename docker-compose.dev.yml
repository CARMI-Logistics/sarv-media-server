# =============================================================================
# Docker Compose Development - Hot Reload
# =============================================================================
# 
# Servicios con volúmenes montados para desarrollo en tiempo real:
#   - Frontend: npm run dev (Vite HMR en puerto 5173)
#   - Backend: Compilación automática con cargo watch
#
# Uso:
#   docker compose -f docker-compose.dev.yml up
#
# NOTA: Este archivo es solo para desarrollo local. No usar en producción.
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Frontend Dev Server (Vite HMR)
  # ---------------------------------------------------------------------------
  frontend-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: frontend-dev
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:8080
    command: npm run dev -- --host 0.0.0.0
    networks:
      - dev-network

  # ---------------------------------------------------------------------------
  # Backend Dev (Cargo Watch)
  # ---------------------------------------------------------------------------
  backend-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: backend-dev
    ports:
      - "8080:8080"
    volumes:
      - ./src:/app/src
      - ./templates:/app/templates
      - ./Cargo.toml:/app/Cargo.toml
      - ./Cargo.lock:/app/Cargo.lock
      - backend-data-dev:/app/data
      - ./recordings:/recordings
      - backup-logs:/app/data/sync_logs
    environment:
      - SERVER_PORT=8080
      - JWT_EXP_MINUTES=60
      - RUST_LOG=debug
      - DATABASE_PATH=/app/data/cameras.db
      - MEDIAMTX_API_URL=http://mediamtx:9997
      - MEDIAMTX_API_USER=admin
      - MEDIAMTX_API_PASS=mediamtx_secret
      - STATIC_DIR=/app/static
      - FRONTEND_URL=http://localhost:5173
      - EMAIL_FROM=noreply@example.com
    command: cargo watch -x run --why
    depends_on:
      - mediamtx
    networks:
      - dev-network

  # ---------------------------------------------------------------------------
  # MediaMTX - Servidor de Streaming (igual que producción)
  # ---------------------------------------------------------------------------
  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: mediamtx-dev
    volumes:
      - ./mediamtx.yml:/mediamtx.yml:ro
      - ./recordings:/recordings
    command: ["/mediamtx.yml"]
    ports:
      - "8554:8554"
      - "8322:8322"
      - "1935:1935"
      - "1936:1936"
      - "8888:8888"
      - "8889:8889"
      - "8189:8189/udp"
      - "9997:9997"
      - "9998:9998"
      - "8000-8007:8000-8007/udp"
      - "8890:8890/udp"
    networks:
      - dev-network

  # ---------------------------------------------------------------------------
  # MinIO S3 - Almacenamiento de objetos compatible con S3
  # ---------------------------------------------------------------------------
  minio:
    image: minio/minio:latest
    container_name: minio-dev
    ports:
      - "9000:9000"  # API S3
      - "9001:9001"  # Consola web
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - dev-network

  # ---------------------------------------------------------------------------
  # RClone Sync - Backup automático cada hora a MinIO S3
  # ---------------------------------------------------------------------------
  rclone-sync:
    build:
      context: ./scripts
      dockerfile: Dockerfile.rclone
    container_name: rclone-sync
    volumes:
      - ./recordings:/recordings:ro
      - ./scripts/rclone:/config/rclone
      - ./scripts/backup.sh:/backup.sh:ro
      - ./scripts/health-check.sh:/health-check.sh:ro
      - ./scripts/manual-sync.sh:/manual-sync.sh:ro
      - backup-logs:/logs
    environment:
      - RCLONE_CONFIG=/config/rclone/rclone.conf
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin123
      - S3_BUCKET=recordings
      - SYNC_INTERVAL=3600
      - LOG_LEVEL=INFO
    command: /bin/bash /backup.sh
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - dev-network
    restart: unless-stopped

volumes:
  backend-data-dev:
    driver: local
  minio-data:
    driver: local
  backup-logs:
    driver: local

networks:
  dev-network:
    driver: bridge
